ServerRoot "/usr/local/apache2"
ServerName 192.168.212.128
Listen 80
Listen 443

LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so

# Важно: настройки пользователя и группы
User daemon
Group daemon

<Directory />
    AllowOverride none
    Require all denied
</Directory>

DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

ErrorLog /dev/stderr
CustomLog /dev/stdout combined

# SSL Global Configuration
SSLRandomSeed startup builtin
SSLRandomSeed connect builtin
SSLSessionCache "shmcb:/usr/local/apache2/logs/ssl_scache(512000)"
SSLSessionCacheTimeout 300

# HTTP VirtualHost (редирект на HTTPS)
<VirtualHost *:80>
    ServerName 192.168.212.128
    Redirect permanent / https://192.168.212.128/
</VirtualHost>

# HTTPS VirtualHost
<VirtualHost *:443>
    ServerName 192.168.212.128
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/ssl/server.crt
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/server.key
    
    # Modern SSL Settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # Proxy Configuration
    ProxyPreserveHost On
    ProxyPass /api/ http://backend:80/
    ProxyPassReverse /api/ http://backend:80/
    ProxyPass / http://frontend:80/
    ProxyPassReverse / http://frontend:80/
</VirtualHost>