import{_ as z}from"./TDonutChart-BDfA_Ukt.js";import{D as J,r as d,h as Y,i as W,m as K,e as n,c as T,w as l,l as s,a as L,g as h,k as $,E as Q,t as E,F as U,y as X,K as Z,u as tt,o as w}from"./index-Dlkkv6Iw.js";import{T as et,a as at,b as G}from"./TRegionCard-D4QU5AL_.js";import{a as H}from"./index-DHjOUhyH.js";import{g as st,d as lt,c as B,h as M}from"./utils-DAVKSodD.js";import"./VDateInput-DTHU6aHi.js";import"./TIcon-Cx-csgO5.js";const nt=J("district",()=>{const x=d(!1),t=d("За прошлый месяц"),F=d([]),_=d(""),m=d(""),y=d([]),v=d([]),g=d([]),k=Y(()=>_.value),S=Y(()=>m.value),D=Y(()=>x.value),C=Y(()=>y.value||[]),I=Y(()=>v.value||[]),R=Y(()=>v.value||[]),P=Y(()=>g.value),A=Y(()=>v.value.name||"Общая статистика"),N=()=>{g.value=[]},j=async()=>{x.value=!0},V=async()=>{x.value=!1},a=r=>{y.value=Array.isArray(r)?r:[]},e=()=>{y.value=[],v.value=[]},o=()=>{F.value=g.value.map(r=>r.id),t.value="За прошлый месяц",i(t.value)},i=r=>{let u;switch(r){case"За прошлый месяц":u=B();break;case"За прошлый квартал":u=lt();break;case"За прошлый год":u=st();break;default:u={startDate:null,endDate:null}}_.value=u.startDate,m.value=u.endDate};return{loading:x,districtsToRequest:g,startDate:_,endDate:m,selectedItems:F,selectedPeriod:t,getStartDate:k,getEndDate:S,isLoading:D,getDistrictsToRequest:P,getStatistics:C,getAllStatistics:I,getAllStat:R,getDistrictName:A,startLoading:j,endLoading:V,setStatistics:a,dropStatistics:e,loadDistrictsToRequest:async()=>{try{const r=await H.subjects.readDistricts();g.value=r.data}catch(r){console.error("Ошибка при загрузке субъектов:",r),N()}},loadStatistics:async r=>{var u,c;try{const p=await H.statistics.readDistricts(r);y.value=((u=p.data)==null?void 0:u.districts)||[],v.value=((c=p.data)==null?void 0:c.stat)||[],_.value=p.startDate,m.value=p.endDate}catch(p){throw console.error("Ошибка при загрузке статистики:",p),e(),p}},initializeForm:o,updateDatesByPeriod:i,resetForm:()=>{_.value=null,m.value=null,F.value=g.value.map(r=>r.id),t.value="За прошлый месяц",i(t.value)}}}),vt={__name:"DistrictPage",setup(x){const t=nt(),F=tt(),_=({eventData:a,startDate:e,endDate:o,type:i,name:b})=>{const f={type:i,label:a.label};e&&(f.startDate=e),o&&(f.endDate=o),b&&(f.name=b),console.log("OpenTable",f),F.push({name:"table",query:f})},m=d(!1),y=d(!1),v=d(!1),g=d(!1),k=d(null),S=d(!1),D=d(null),C=Y(()=>t.isLoading||S.value),I=()=>{const a={startDate:t.startDate,endDate:t.endDate};return t.selectedItems.length>0&&(a.ids=t.selectedItems.toString()),a},R=async()=>{try{y.value=!0,S.value=!0,D.value=null;const a=new Date(t.startDate),e=B(a);t.startDate=e.startDate,t.endDate=e.endDate;const o=I();await t.loadStatistics(o)}catch(a){D.value=a.message,t.dropStatistics()}finally{y.value=!1,S.value=!1}},P=async()=>{try{const a=new Date(t.startDate);if(a.setMonth(a.getMonth()+1),a>new Date){Z.warning("Нельзя переходить в будущее");return}a.setMonth(a.getMonth()+1),v.value=!0,S.value=!0,D.value=null;const e=B(a);t.startDate=e.startDate,t.endDate=e.endDate;const o=I();await t.loadStatistics(o)}catch(a){D.value=a.message,t.dropStatistics()}finally{v.value=!1,S.value=!1}},A=a=>{const e=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),i=String(a.getDate()).padStart(2,"0");return`${e}-${o}-${i}`},N=(a,e,o)=>{const i={};return e&&(i.startDate=e),o&&(i.endDate=o),a.length>0&&(i.ids=a.toString()),i},j=async a=>{try{await t.startLoading(),t.selectedItems=[...a.selectedItems],t.selectedPeriod=a.selectedPeriod,t.startDate=A(a.startDate),t.endDate=A(a.endDate);const e=N(t.selectedItems,t.startDate,t.endDate);await t.loadStatistics(e)}catch{t.dropStatistics()}finally{await t.endLoading()}},V=async()=>{try{g.value=!0,k.value=null,await t.loadDistrictsToRequest(),S.value=!0,D.value=null,t.initializeForm();const a=I();await t.loadStatistics(a)}catch(a){k.value=a.message,D.value=a.message,t.dropStatistics()}finally{g.value=!1,S.value=!1}};return W(async()=>{await V()}),(a,e)=>{const o=L("v-btn"),i=L("v-container"),b=L("v-col"),f=L("v-row"),O=L("v-alert"),r=L("v-icon");return w(),K(U,null,[n(s(at),{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=u=>m.value=u),loading:g.value},{form:l(()=>[n(s(et),{loading:s(t).isLoading,items:s(t).getDistrictsToRequest,onSubmit:e[0]||(e[0]=u=>j(u))},null,8,["loading","items"])]),_:1},8,["modelValue","loading"]),n(f,{"no-gutters":"",class:"justify-start"},{default:l(()=>[n(b,null,{default:l(()=>[n(i,{fluid:"",class:"my-0 py-0"},{default:l(()=>[n(o,{color:"primary",variant:"tonal",onClick:e[2]||(e[2]=u=>m.value=!m.value)},{default:l(()=>e[4]||(e[4]=[h(" Фильтры ")])),_:1})]),_:1})]),_:1})]),_:1}),D.value||k.value?(w(),T(f,{key:0},{default:l(()=>[n(b,null,{default:l(()=>[n(i,{fluid:""},{default:l(()=>[k.value?(w(),T(O,{key:0,class:"d-flex align-center justify-center",type:"error",title:"Произошла ошибка",text:D.value||k.value,variant:"tonal"},null,8,["text"])):$("",!0)]),_:1})]),_:1})]),_:1})):(w(),T(f,{key:1,"no-gutters":"",class:"justify-space-around"},{default:l(()=>{var u;return[(u=s(t).getAllStat)!=null&&u.length?(w(),T(b,{key:0,cols:"auto"},{default:l(()=>[n(i,null,{default:l(()=>[n(s(G),{title:s(t).getDistrictName||"Общая статистика","is-loading":C.value,"min-width":400,"max-width":400},Q({chart:l(()=>[n(s(z),{"is-legend-open-table-page":!0,onOnColumnClick:e[3]||(e[3]=c=>_({eventData:c,type:"all-districts-type",name:s(t).getDistrictName||"Общая статистика",startDate:s(M)(s(t).getStartDate,"DD.MM.YYYY"),endDate:s(M)(s(t).getEndDate,"DD.MM.YYYY")})),labels:s(t).getAllStat.map(c=>c.name),series:s(t).getAllStat.map(c=>c.count),height:350,"enable-logarithmic":!1,"log-base":10,"y-start-value":0,"legend-position":"bottom"},null,8,["labels","series"])]),previous:l(()=>[n(o,{color:"primary",loading:y.value,onClick:R},{default:l(()=>[n(r,null,{default:l(()=>e[5]||(e[5]=[h("mdi-arrow-left")])),_:1})]),_:1},8,["loading"])]),next:l(()=>[n(o,{color:"primary",loading:v.value,onClick:P},{default:l(()=>[n(r,null,{default:l(()=>e[6]||(e[6]=[h("mdi-arrow-right")])),_:1})]),_:1},8,["loading"])]),_:2},[C.value?void 0:{name:"interval",fn:l(()=>[h(E(s(M)(s(t).getStartDate,"DD.MM.YYYY"))+" - "+E(s(M)(s(t).getEndDate,"DD.MM.YYYY")),1)]),key:"0"}]),1032,["title","is-loading"])]),_:1})]),_:1})):$("",!0),(w(!0),K(U,null,X(s(t).getStatistics,c=>(w(),T(b,{cols:"auto",key:c.name},{default:l(()=>{var p;return[(p=c==null?void 0:c.stat)!=null&&p.length?(w(),T(i,{key:0},{default:l(()=>[n(s(G),{title:c.name||"Без названия","is-loading":C.value,"min-width":400,"max-width":400},Q({chart:l(()=>[n(s(z),{"is-legend-open-table-page":!0,onOnColumnClick:q=>_({eventData:q,type:"district-type",name:c.name,startDate:s(M)(s(t).getStartDate,"DD.MM.YYYY"),endDate:s(M)(s(t).getEndDate,"DD.MM.YYYY")}),labels:c.stat.map(q=>q.name),series:c.stat.map(q=>q.count),height:350,"enable-logarithmic":!1,"log-base":10,"y-start-value":0,"legend-position":"bottom"},null,8,["onOnColumnClick","labels","series"])]),previous:l(()=>[n(o,{color:"primary",loading:y.value,onClick:R},{default:l(()=>[n(r,null,{default:l(()=>e[7]||(e[7]=[h("mdi-arrow-left")])),_:1})]),_:1},8,["loading"])]),next:l(()=>[n(o,{color:"primary",loading:v.value,onClick:P},{default:l(()=>[n(r,null,{default:l(()=>e[8]||(e[8]=[h("mdi-arrow-right")])),_:1})]),_:1},8,["loading"])]),_:2},[C.value?void 0:{name:"interval",fn:l(()=>[h(E(s(M)(s(t).getStartDate,"DD.MM.YYYY"))+" - "+E(s(M)(s(t).getEndDate,"DD.MM.YYYY")),1)]),key:"0"}]),1032,["title","is-loading"])]),_:2},1024)):$("",!0)]}),_:2},1024))),128))]}),_:1}))],64)}}};export{vt as default};
