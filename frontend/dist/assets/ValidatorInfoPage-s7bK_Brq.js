import{f as Z,a as O}from"./utils-DAVKSodD.js";import{c as q,_ as Ce,a as J,b as Ie,d as Ue}from"./ReportTableCard.vue_vue_type_script_setup_true_lang-NvFTJG-a.js";import{a as $}from"./index-DHjOUhyH.js";import{d as Oe,r as m,h as _,n as $e,i as Le,j as Ne,c as k,w as t,a as i,e as a,k as x,f as se,g as r,t as V,l as L,m as Fe,K as re,o as f}from"./index-Dlkkv6Iw.js";import{V as ne}from"./VDateInput-DTHU6aHi.js";const Pe={key:1},He=Oe({__name:"ValidatorInfoPage",setup(Ye){const j={taskId:"",state:"UNKNOWN",status:"Загружаем информацию о сборе данных...",duration:0,startTime:"",endTime:"",progress:0,report:{details:{},summary:{total:0,processed:0,validationSuccessful:0,validationFailed:0,failed:0,startDate:"",endDate:"",averageSimilarity:0}}},ie="http://publication.pravo.gov.ru/document/",ue={email:o=>/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(o)||"Неверный e-mail."},p=m({...j}),u=m([]),n=m({...j}),N=m(!0),K=m(50),w=m(!1),S=m(!1),Q=[{key:"total",order:"desc"}];let z;function de(o){const e=u.value.find(s=>s.taskId===o);n.value=e?{...e}:{...j}}const me=[{title:"Статус",key:"state",align:"start",sortable:!0},{title:"Дата",key:"startTime",sortable:!0},{title:"Длительность",key:"duration",sortable:!0},{title:"Обработано",key:"summary",align:"start",sortable:!1},{title:"Отчет",key:"taskId",align:"center",sortable:!1}],ce=[{title:"Источник",key:"idReg",align:"start"},{title:"Тип",key:"idType",align:"start"},{title:"Состояние",key:"state",align:"start"},{title:"Схожесть",key:"reason",align:"start"},{title:"Валиден",key:"error",align:"start"},{title:"Отчет",key:"id",align:"center"}],ve=_(()=>!n.value||!n.value.report||!n.value.report.details?[]:Object.entries(n.value.report.details).map(([o,e])=>({id:o,error:e.error||"Unknown",idReg:e.idReg||0,idType:e.idType||0,reason:e.reason||{},state:e.state||0}))),pe=_(()=>{var o,e,s,c,D,b,A,y,h,I,v,U;return[{name:"Начало",value:Z(n.value.startTime),icon:"mdi-clock-outline"},{name:"Окончание",value:Z(n.value.endTime),icon:"mdi-clock-check-outline"},{name:"Длительность",value:O(n.value.duration),icon:"mdi-timer-outline"},{name:"Всего документов",value:((e=(o=n.value.report)==null?void 0:o.summary)==null?void 0:e.total)||0,icon:"mdi-file-document-outline"},{name:"Обработано документов",value:((c=(s=n.value.report)==null?void 0:s.summary)==null?void 0:c.processed)||0,icon:"mdi-file-document-check-outline"},{name:"Успешные проверки",value:((b=(D=n.value.report)==null?void 0:D.summary)==null?void 0:b.validationSuccessful)||0,icon:"mdi-check-circle-outline",color:"success"},{name:"Ошибки проверки",value:((y=(A=n.value.report)==null?void 0:A.summary)==null?void 0:y.validationFailed)||0,icon:"mdi-alert-circle-outline",color:"error"},{name:"Ошибки обработки",value:((I=(h=n.value.report)==null?void 0:h.summary)==null?void 0:I.failed)||0,icon:"mdi-alert-circle-outline",color:"error"},{name:"Процент схожести",value:((U=(v=n.value.report)==null?void 0:v.summary)==null?void 0:U.averageSimilarity)||0,icon:"mdi-percent-outline",color:"gray"}]}),X=_(()=>p.value.state==="STARTED"||p.value.state==="PROGRESS"),T=_(()=>u.value&&u.value.length>0),fe=_(()=>[{name:"Длительность",data:u.value.filter(e=>e.duration).slice().reverse().map(e=>e.duration)}]),ye=_(()=>{const o=u.value.filter(e=>e.duration).slice().reverse();return{chart:{type:"area",toolbar:{show:!1},zoom:!1,fontFamily:"Nunito, sans-serif"},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",color:["#"],gradient:{shadeIntensity:1,opacityFrom:.9,opacityTo:.5}},xaxis:{categories:o.map((e,s)=>`Запуск ${s+1}`),labels:{show:!1}},yaxis:{logarithmic:!1,logBase:10,labels:{show:!0,formatter:function(e){return O(e)}},title:{show:!1},tooltip:{y:{formatter:function(e){return O(e)}}},theme:{mode:"light",palette:"palette1",monochrome:{enabled:!0,color:"#1d4c86",shadeTo:"light",shadeIntensity:.65}}}}}),ge=_(()=>u.value.filter(o=>o.state==="SUCCESS").length),_e=_(()=>u.value.filter(o=>o.state==="FAILURE"||o.state==="REVOKED").length),ke=_(()=>{const o=u.value.filter(c=>c.duration);if(o.length===0)return"0 сек";const s=o.reduce((c,D)=>c+D.duration,0)/o.length;return O(s)}),ee=o=>o==="SUCCESS"?"success":o==="FAILURE"||o==="REVOKED"?"error":o==="STARTED"||o==="PROGRESS"?"primary":"grey",F=async()=>{try{const o=await $.validator.status();p.value=q(o),p.value.state==="SUCCESS"&&(await E(),await H())}catch(o){console.error("Error fetching validator status:",o)}finally{N.value=!1}},E=async()=>{try{N.value=!0;const o=await $.validator.history({limit:K.value});u.value=o.history?o.history.map(q):[],u.value.length>0&&!n.value&&H()}catch(o){console.error("Error fetching validator history:",o)}finally{N.value=!1}},H=async()=>{try{const o=await $.validator.lastRun();n.value=q(o)}catch(o){if(o.response&&o.response.status===404&&u.value.length>0){const e=[...u.value].sort((s,c)=>new Date(c.startTime).getTime()-new Date(s.startTime).getTime());e[0]&&e[0].report&&(n.value={...e[0]})}else o.response&&o.response.status!==404&&console.error("Error fetching last report:",o)}},Ve=async()=>{try{S.value=!0;const o={startDate:C.format(d.value.startDate,"YYYY-MM-DD").toString().split(",")[0],endDate:C.format(d.value.endDate,"YYYY-MM-DD").toString().split(",")[0],sendEmail:d.value.sendEmail,recipientEmail:d.value.recipientEmail},e=await $.validator.start(o);console.log("Response from startValidator:",e),e.status===200&&re.success("Проверка данных запущена"),await new Promise(s=>setTimeout(s,2e3)),await F(),await E()}catch{re.error("Не удалось запустить процесс проверки данных")}finally{S.value=!1,R.value=!1}},be=()=>{R.value=!0},he=()=>{console.log("showStopDialog"),w.value=!0},xe=async()=>{w.value=!1;try{await $.validator.stop(),await F(),await E()}catch(o){console.error("Error stopping validator:",o)}},De=()=>{z=setInterval(async()=>{X.value&&await F()},3e3)},R=m(!1),M=m(!1),C=$e(),te=o=>C.toISO(o),d=m({sendEmail:!1,recipientEmail:"example@example.com",startDate:C.parseISO("2025-01-01"),endDate:C.parseISO("2025-01-01")}),ae=[o=>!!o||"Это поле обязательно"];m(!1);const P=m(!1),Y=m(null),we=o=>{Y.value=o,P.value=!0};return Le(async()=>{await F(),await E(),await H(),De()}),Ne(()=>{z&&clearInterval(z)}),(o,e)=>{const s=i("v-col"),c=i("v-spacer"),D=i("v-select"),b=i("v-card-title"),A=i("apexchart"),y=i("v-card-text"),h=i("v-card"),I=i("v-chip"),v=i("v-btn"),U=i("v-data-table"),le=i("v-checkbox-btn"),B=i("v-row"),Se=i("v-checkbox"),Te=i("v-text-field"),Ee=i("v-form"),W=i("v-card-actions"),G=i("v-dialog"),oe=i("v-card-subtitle"),Re=i("v-container");return f(),k(Re,{fluid:""},{default:t(()=>[a(B,{class:"justify-space-around"},{default:t(()=>[a(s,{cols:"12",md:"6"},{default:t(()=>[a(Ce,{title:"Статус процесса проверки документов",status:p.value.state,message:p.value.status,progress:p.value.progress,isRunning:X.value,startLoading:S.value,startTime:p.value.startTime,endTime:p.value.endTime,duration:p.value.duration,onStart:be,onConfirm:he},null,8,["status","message","progress","isRunning","startLoading","startTime","endTime","duration"])]),_:1}),T.value?(f(),k(s,{key:0,cols:"12",md:"6"},{default:t(()=>[a(h,{class:"h-100",elevation:"3"},{default:t(()=>[a(b,{class:"d-flex align-center"},{default:t(()=>[e[13]||(e[13]=se("span",null,"Длительность",-1)),a(c),a(D,{modelValue:K.value,"onUpdate:modelValue":[e[0]||(e[0]=l=>K.value=l),E],items:[5,10,20,50],variant:"outlined",density:"compact","hide-details":"",style:{"max-width":"120px"},color:"primary"},null,8,["modelValue"])]),_:1}),a(y,null,{default:t(()=>[a(A,{type:"area",height:"300",options:ye.value,series:fe.value},null,8,["options","series"])]),_:1})]),_:1})]),_:1})):x("",!0),T.value?(f(),k(s,{key:1,cols:"12",md:"4"},{default:t(()=>[a(J,{color:"success",icon:"check",amount:ge.value,description:"Успешная проверка данных"},null,8,["amount"])]),_:1})):x("",!0),T.value?(f(),k(s,{key:2,cols:"12",md:"4"},{default:t(()=>[a(J,{color:"error",icon:"alert",amount:_e.value,description:"Ошибки при выполнении"},null,8,["amount"])]),_:1})):x("",!0),T.value?(f(),k(s,{key:3,cols:"12",md:"4"},{default:t(()=>[a(J,{color:"info",icon:"clock",amount:ke.value,description:"Среднее время выполнения"},null,8,["amount"])]),_:1})):x("",!0),a(s,{cols:"12",md:T.value?6:12},{default:t(()=>[a(Ie,{historyLimit:"20"},{table:t(()=>[a(U,{headers:me,items:u.value,loading:N.value,"items-per-page":"15","items-per-page-options":[15,20,50],"fixed-header":"","fixed-footer":"",height:"700",density:"compact",hover:""},{"item.state":t(({item:l})=>[a(I,{color:ee(l.state),size:"small",label:""},{default:t(()=>[r(V(l.state),1)]),_:2},1032,["color"])]),"item.duration":t(({item:l})=>[r(V(L(O)(l.duration)),1)]),"item.startTime":t(({item:l})=>[r(V(L(Z)(l.startTime)),1)]),"item.summary":t(({item:l})=>{var g;return[r(V(((g=l.report.summary)==null?void 0:g.processed)||0),1)]}),"item.taskId":t(({item:l})=>[a(v,{class:"text-none ma-1","prepend-icon":"mdi-text-box-search",variant:"text",onClick:g=>de(l.taskId)},{default:t(()=>e[14]||(e[14]=[r(" Смотреть ")])),_:2},1032,["onClick"])]),_:1},8,["items","loading"])]),_:1})]),_:1},8,["md"]),a(s,{cols:"12",md:"6"},{default:t(()=>[a(Ue,{status:n.value.state,message:n.value.status,stats:pe.value},{table:t(()=>[n.value&&n.value.report&&n.value.report.details?(f(),k(U,{key:0,headers:ce,items:ve.value,density:"compact","fixed-header":"","fixed-footer":"",height:"400","sort-by":Q,"onUpdate:sortBy":e[1]||(e[1]=l=>Q=l),hover:""},{"item.error":t(({item:l})=>[l.error==="INVALID"&&typeof l.reason=="object"?(f(),k(le,{key:0,modelValue:l.reason.isValid,"onUpdate:modelValue":g=>l.reason.isValid=g,"hide-details":"","true-value":!0,"false-value":!1,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])):(f(),Fe("span",Pe," Другое "))]),"item.state":t(({item:l})=>[a(I,{color:ee(l.state),size:"small",label:""},{default:t(()=>[r(V(l.state),1)]),_:2},1032,["color"])]),"item.reason":t(({item:l})=>[r(V(typeof l.reason=="object"?l.reason.similarity:0)+"% ",1)]),"item.":t(({item:l})=>[typeof l.reason=="object"?(f(),k(le,{key:0,modelValue:l.reason.isValid,"onUpdate:modelValue":g=>l.reason.isValid=g,"hide-details":"","true-value":!0,"false-value":!1,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])):x("",!0)]),"item.id":t(({item:l})=>[a(v,{class:"text-none ma-1","prepend-icon":"mdi-text-box-search",variant:"text",onClick:g=>we(l)},{default:t(()=>e[15]||(e[15]=[r(" Проверить ")])),_:2},1032,["onClick"])]),_:1},8,["items"])):x("",!0)]),_:1},8,["status","message","stats"])]),_:1})]),_:1}),a(G,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=l=>R.value=l),"max-width":"600"},{default:t(()=>[a(h,{class:"px-2 py-2"},{default:t(()=>[a(b,null,{default:t(()=>e[16]||(e[16]=[r("Параметры проверки документов")])),_:1}),a(y,{class:"py-2"},{default:t(()=>[a(Ee,{ref:"validationForm",modelValue:M.value,"onUpdate:modelValue":e[6]||(e[6]=l=>M.value=l)},{default:t(()=>[a(B,null,{default:t(()=>[a(s,{cols:"12",md:"6"},{default:t(()=>[a(L(ne),{modelValue:d.value.startDate,"onUpdate:modelValue":e[2]||(e[2]=l=>d.value.startDate=l),label:"Начальная дата","display-format":te,"prepend-inner-icon":"mdi-calendar-blank","prepend-icon":"",variant:"outlined",rules:ae},null,8,["modelValue"])]),_:1}),a(s,{cols:"12",md:"6"},{default:t(()=>[a(L(ne),{modelValue:d.value.endDate,"onUpdate:modelValue":e[3]||(e[3]=l=>d.value.endDate=l),label:"Конечная дата","display-format":te,"prepend-inner-icon":"mdi-calendar-blank","prepend-icon":"",variant:"outlined",rules:ae},null,8,["modelValue"])]),_:1})]),_:1}),a(B,{class:"mt-0 pt-0"},{default:t(()=>[a(s,{cols:"12",class:"my-0 py-0"},{default:t(()=>[a(Se,{modelValue:d.value.sendEmail,"onUpdate:modelValue":e[4]||(e[4]=l=>d.value.sendEmail=l),label:"Отправить уведомление по email","hide-details":"",density:"compact"},null,8,["modelValue"]),d.value.sendEmail?(f(),k(Te,{key:0,modelValue:d.value.recipientEmail,"onUpdate:modelValue":e[5]||(e[5]=l=>d.value.recipientEmail=l),label:"Email получателя","prepend-inner-icon":"mdi-email-outline",variant:"outlined",rules:[ue.email]},null,8,["modelValue","rules"])):x("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(W,null,{default:t(()=>[a(c),a(v,{color:"primary",variant:"tonal",onClick:e[7]||(e[7]=l=>R.value=!1)},{default:t(()=>e[17]||(e[17]=[r(" Отменить ")])),_:1}),a(v,{color:"success",variant:"tonal",onClick:Ve,disabled:!M.value||S.value,loading:S.value},{default:t(()=>e[18]||(e[18]=[r(" Начать проверку ")])),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(G,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=l=>w.value=l),"max-width":"500"},{default:t(()=>[a(h,{class:"px-2 py-2"},{default:t(()=>[a(b,null,{default:t(()=>e[19]||(e[19]=[r(" Подтвердите остановку ")])),_:1}),a(y,null,{default:t(()=>e[20]||(e[20]=[r(" Вы уверены, что хотите "),se("strong",null,"остановить",-1),r(" процесс валидации данных? Это действие необратимо. ")])),_:1}),a(W,null,{default:t(()=>[a(c),a(v,{color:"primary",variant:"tonal",onClick:e[9]||(e[9]=l=>w.value=!1)},{default:t(()=>e[21]||(e[21]=[r(" Отменить ")])),_:1}),a(v,{color:"error",variant:"tonal",onClick:xe},{default:t(()=>e[22]||(e[22]=[r(" Остановить ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(G,{modelValue:P.value,"onUpdate:modelValue":e[12]||(e[12]=l=>P.value=l),"max-width":"800"},{default:t(()=>[a(h,{class:"px-2 py-2"},{default:t(()=>[a(b,null,{default:t(()=>e[23]||(e[23]=[r("Сравнение текстов")])),_:1}),a(y,{class:"px-2 py-2"},{default:t(()=>[a(B,null,{default:t(()=>[a(s,{cols:"6"},{default:t(()=>[a(oe,null,{default:t(()=>e[24]||(e[24]=[r("Текст из БД")])),_:1}),a(y,{class:"bg-grey-lighten-4",style:{"white-space":"pre-wrap"}},{default:t(()=>{var l;return[r(V((l=Y.value)==null?void 0:l.reason.dbText),1)]}),_:1})]),_:1}),a(s,{cols:"6"},{default:t(()=>[a(oe,null,{default:t(()=>e[25]||(e[25]=[r("Текст из OCR")])),_:1}),a(y,{class:"bg-grey-lighten-4",style:{"white-space":"pre-wrap"}},{default:t(()=>{var l;return[r(V((l=Y.value)==null?void 0:l.reason.ocrText),1)]}),_:1})]),_:1})]),_:1})]),_:1}),a(W,{class:"gap-4"},{default:t(()=>{var l;return[a(v,{color:"error",variant:"tonal",onClick:e[11]||(e[11]=g=>P.value=!1)},{default:t(()=>e[26]||(e[26]=[r(" Закрыть ")])),_:1}),a(v,{color:"primary",variant:"tonal",href:L(ie)+((l=Y.value)==null?void 0:l.reason.eoNumber),target:"_blank"},{default:t(()=>e[27]||(e[27]=[r(" Открыть документ ")])),_:1},8,["href"])]}),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}});export{He as default};
