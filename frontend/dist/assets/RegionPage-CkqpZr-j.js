import{_ as W}from"./TDonutChart-BDfA_Ukt.js";import{D as st,r as i,h as m,i as lt,m as X,e as n,c as x,k as Q,w as s,l,a as C,g as h,E as Z,t as V,F as tt,y as nt,b as ot,K as rt,u as it,o as k}from"./index-Dlkkv6Iw.js";import{T as ut,a as ct,b as et}from"./TRegionCard-D4QU5AL_.js";import{a as at}from"./index-DHjOUhyH.js";import{g as dt,d as mt,c as U,h as I}from"./utils-DAVKSodD.js";import"./VDateInput-DTHU6aHi.js";import"./TIcon-Cx-csgO5.js";const vt=st("region",()=>{const L=i(!1),g=i("За прошлый месяц"),j=i([]),t=i(""),y=i(""),D=i([]),f=i({}),b=i([]),Y=i(""),_=i([]),S=i([]),R=m(()=>t.value),q=m(()=>y.value),P=m(()=>L.value),F=m(()=>D.value),A=m(()=>Y.value),T=m(()=>b.value),N=m(()=>f.value),B=m(()=>b.value),$=m(()=>f.value),O=m(()=>S.value),a=m(()=>_.value),e=()=>{D.value=[]},r=async()=>{L.value=!0},c=async()=>{L.value=!1},p=u=>{f.value=u},d=()=>{f.value={}},E=()=>{j.value=D.value.map(u=>u.id),g.value="За прошлый месяц",w(g.value)},w=u=>{let v;switch(u){case"За прошлый месяц":v=U();break;case"За прошлый квартал":v=mt();break;case"За прошлый год":v=dt();break;default:v={startDate:null,endDate:null}}t.value=v.startDate,y.value=v.endDate};return{loading:L,statistics:f,allStatistics:b,regionsToRequest:D,startDate:t,endDate:y,selectedItems:j,selectedPeriod:g,getStartDate:R,getEndDate:q,getDistrictName:A,getDistrictStat:T,isLoading:P,getRegions:$,getStatistics:N,getSubjects:F,getDistrictsForRequest:O,getDistricts:a,getAllStatistics:B,dropSubjects:e,startLoading:r,endLoading:c,setStatistics:p,dropStatistics:d,loadStatisticsAPI:async(u,v)=>{var G,H,J;try{const M=await at.statistics.readDistrictById(u,v);Y.value=((G=M.data)==null?void 0:G.name)||"",f.value=((H=M.data)==null?void 0:H.regions)||[],b.value=((J=M.data)==null?void 0:J.stat)||[],t.value=M.startDate,y.value=M.endDate}catch(M){throw console.error("Ошибка при загрузке статистики:",M),d(),M}},loadSubjectsAPI:async u=>{try{const v=await at.subjects.readRegions({districtId:u});D.value=v.data}catch(v){console.error("Ошибка при загрузке субъектов:",v),e()}},initializeForm:E,updateDatesByPeriod:w,resetForm:()=>{t.value=null,y.value=null,j.value=D.value.map(u=>u.id),g.value="За прошлый месяц",w(g.value)}}}),_t={__name:"RegionPage",setup(L){const g=ot(),j=it(),t=vt(),y=i(!1),D=i(!1),f=i(!1),b=i(!1),Y=i(null),_=i(!1),S=i(null),R=({eventData:a,startDate:e,endDate:r,type:c,name:p})=>{const d={type:c,label:a.label};e&&(d.startDate=e),r&&(d.endDate=r),p&&(d.name=p),console.log("OpenTable",d),j.push({name:"table",query:d})},q=m(()=>t.allStatistics.length===0),P=m(()=>t.isLoading||_.value),F=()=>{const a={startDate:t.startDate,endDate:t.endDate};return t.selectedItems.length>0&&(a.ids=t.selectedItems.toString()),a},A=async()=>{try{D.value=!0,_.value=!0,S.value=null;const a=new Date(t.startDate),e=U(a);t.startDate=e.startDate,t.endDate=e.endDate;const r=F();await t.loadStatisticsAPI(g.params.id,r)}catch(a){S.value=a.message,t.dropStatistics()}finally{D.value=!1,_.value=!1}},T=async()=>{try{const a=new Date(t.startDate);if(a.setMonth(a.getMonth()+1),a>new Date){rt.warning("Нельзя переходить в будущее");return}a.setMonth(a.getMonth()+1),f.value=!0,_.value=!0,S.value=null;const e=U(a);t.startDate=e.startDate,t.endDate=e.endDate;const r=F();await t.loadStatisticsAPI(g.params.id,r)}catch(a){S.value=a.message,t.dropStatistics()}finally{f.value=!1,_.value=!1}},N=a=>{const e=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),c=String(a.getDate()).padStart(2,"0");return`${e}-${r}-${c}`},B=(a,e,r)=>{const c={};return e&&(c.startDate=e),r&&(c.endDate=r),a.length>0&&(c.ids=a.toString()),c},$=async a=>{try{await t.startLoading(),t.selectedItems=[...a.selectedItems],t.selectedPeriod=a.selectedPeriod,t.startDate=N(a.startDate),t.endDate=N(a.endDate);const e=B(t.selectedItems,t.startDate,t.endDate);await t.loadStatisticsAPI(g.params.id,e)}catch{t.dropStatistics()}finally{await t.endLoading()}},O=async()=>{try{b.value=!0,Y.value=null,await t.loadSubjectsAPI(g.params.id),_.value=!0,S.value=null,t.initializeForm();const a=F();await t.loadStatisticsAPI(g.params.id,a)}catch(a){Y.value=a.message,S.value=a.message,t.dropStatistics()}finally{b.value=!1,_.value=!1}};return lt(async()=>{await O()}),(a,e)=>{const r=C("v-btn"),c=C("v-container"),p=C("v-col"),d=C("v-row"),E=C("v-alert"),w=C("v-icon");return k(),X(tt,null,[n(l(ct),{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=o=>y.value=o),loading:b.value},{form:s(()=>[n(l(ut),{loading:l(t).isLoading,items:l(t).getSubjects,onSubmit:e[0]||(e[0]=o=>$(o))},null,8,["loading","items"])]),_:1},8,["modelValue","loading"]),n(d,{"no-gutters":"",class:"justify-start"},{default:s(()=>[n(p,null,{default:s(()=>[n(c,{fluid:"",class:"my-0 py-0"},{default:s(()=>[n(r,{color:"primary",variant:"tonal",onClick:e[2]||(e[2]=o=>y.value=!y.value)},{default:s(()=>e[4]||(e[4]=[h(" Фильтры ")])),_:1})]),_:1})]),_:1})]),_:1}),S.value||Y.value?(k(),x(d,{key:0},{default:s(()=>[n(p,null,{default:s(()=>[n(c,{fluid:""},{default:s(()=>[Y.value?(k(),x(E,{key:0,class:"d-flex align-center justify-center",type:"error",title:"Произошла ошибка",text:S.value||Y.value,variant:"tonal"},null,8,["text"])):Q("",!0)]),_:1})]),_:1})]),_:1})):Q("",!0),q.value?(k(),x(d,{key:1},{default:s(()=>[n(p,null,{default:s(()=>[n(c,{fluid:""},{default:s(()=>[Y.value?(k(),x(E,{key:0,class:"d-flex align-center justify-center",type:"info",title:"Упс...",text:"Нет данных по выбранным фильтрам",variant:"tonal"})):Q("",!0)]),_:1})]),_:1})]),_:1})):(k(),x(d,{key:2,"no-gutters":"",class:"justify-space-around"},{default:s(()=>[n(p,{cols:"auto"},{default:s(()=>[n(c,null,{default:s(()=>[n(l(et),{title:l(t).getDistrictName,"is-loading":P.value,"min-width":400,"max-width":400},Z({chart:s(()=>[n(l(W),{"is-legend-open-table-page":!0,onOnColumnClick:e[3]||(e[3]=o=>R({eventData:o,type:"district-type",name:l(t).getDistrictName,startDate:l(I)(l(t).getStartDate,"DD.MM.YYYY"),endDate:l(I)(l(t).getEndDate,"DD.MM.YYYY")})),labels:l(t).getDistrictStat.map(o=>o.name),series:l(t).getDistrictStat.map(o=>o.count),height:350,"enable-logarithmic":!1,"log-base":10,"y-start-value":0,"legend-position":"bottom"},null,8,["labels","series"])]),previous:s(()=>[n(r,{color:"primary",loading:D.value,onClick:A},{default:s(()=>[n(w,null,{default:s(()=>e[5]||(e[5]=[h("mdi-arrow-left")])),_:1})]),_:1},8,["loading"])]),next:s(()=>[n(r,{color:"primary",loading:f.value,onClick:T},{default:s(()=>[n(w,null,{default:s(()=>e[6]||(e[6]=[h("mdi-arrow-right")])),_:1})]),_:1},8,["loading"])]),_:2},[P.value?void 0:{name:"interval",fn:s(()=>[h(V(l(I)(l(t).getStartDate,"DD.MM.YYYY"))+" - "+V(l(I)(l(t).getEndDate,"DD.MM.YYYY")),1)]),key:"0"}]),1032,["title","is-loading"])]),_:1})]),_:1}),(k(!0),X(tt,null,nt(l(t).getRegions,o=>(k(),x(p,{cols:"auto",key:o},{default:s(()=>[n(c,null,{default:s(()=>[n(l(et),{title:o.name,"is-loading":P.value,"min-width":400,"max-width":400},Z({chart:s(()=>{var z,K;return[n(l(W),{"is-legend-open-table-page":!0,onOnColumnClick:u=>R({eventData:u,type:"region-type",name:o.name,startDate:l(I)(l(t).getStartDate,"DD.MM.YYYY"),endDate:l(I)(l(t).getEndDate,"DD.MM.YYYY")}),labels:(z=o==null?void 0:o.stat)==null?void 0:z.map(u=>u.name),series:(K=o==null?void 0:o.stat)==null?void 0:K.map(u=>u.count),height:350,"enable-logarithmic":!1,"log-base":10,"y-start-value":0,"legend-position":"bottom"},null,8,["onOnColumnClick","labels","series"])]}),previous:s(()=>[n(r,{color:"primary",loading:D.value,onClick:A},{default:s(()=>[n(w,null,{default:s(()=>e[7]||(e[7]=[h("mdi-arrow-left")])),_:1})]),_:1},8,["loading"])]),next:s(()=>[n(r,{color:"primary",loading:f.value,onClick:T},{default:s(()=>[n(w,null,{default:s(()=>e[8]||(e[8]=[h("mdi-arrow-right")])),_:1})]),_:1},8,["loading"])]),_:2},[P.value?void 0:{name:"interval",fn:s(()=>[h(V(l(I)(l(t).getStartDate,"DD.MM.YYYY"))+" - "+V(l(I)(l(t).getEndDate,"DD.MM.YYYY")),1)]),key:"0"}]),1032,["title","is-loading"])]),_:2},1024)]),_:2},1024))),128))]),_:1}))],64)}}};export{_t as default};
