import{f as U,a as h}from"./utils-DAVKSodD.js";import{c as P,_ as pe,a as L,b as ve,d as fe}from"./ReportTableCard.vue_vue_type_script_setup_true_lang-NvFTJG-a.js";import{a as k}from"./index-DHjOUhyH.js";import{d as ye,r as y,h as m,i as ge,j as _e,c as v,w as a,a as n,o as c,e as o,k as b,f as A,g as u,t as f,l as K,m as j}from"./index-Dlkkv6Iw.js";const he={key:1},ke={key:1},De=ye({__name:"ParserInfoPage",setup(be){const S={taskId:"",state:"UNKNOWN",status:"Загружаем информацию о сборе данных...",duration:0,startTime:"",endTime:"",progress:0,report:{organs:{},summary:{organsProcessed:0,organsTotal:0,totalDocuments:0,successful:0,failed:0,skipped:0}}},d=y({...S}),i=y([]),r=y({...S}),w=y(!0),D=y(50),g=y(!1),R=y(!1),N=[{key:"total",order:"desc"}];let E;function G(t){const e=i.value.find(l=>l.taskId===t);r.value=e?{...e}:{...S}}const M=[{title:"Статус",key:"state",align:"start",sortable:!0},{title:"Дата",key:"startTime",sortable:!0},{title:"Длительность",key:"duration",sortable:!0},{title:"Обработано",key:"summary",align:"center",sortable:!1},{title:"Отчет",key:"taskId",align:"center",sortable:!1}],q=[{title:"Источник",key:"name",align:"start"},{title:"Код",key:"code",align:"start"},{title:"Всего",key:"total",align:"start"},{title:"Успешно",key:"success",align:"start"},{title:"Ошибки",key:"failed",align:"start"},{title:"Обработан",key:"processed",align:"center"}],J=m(()=>[{name:"Начало",value:U(r.value.startTime),icon:"mdi-clock-outline"},{name:"Окончание",value:U(r.value.endTime),icon:"mdi-clock-check-outline"},{name:"Длительность",value:h(r.value.duration),icon:"mdi-timer-outline"},{name:"Всего источников",value:r.value.report.summary.organsTotal||0,icon:"mdi-database"},{name:"Обработано источников",value:r.value.report.summary.organsProcessed||0,icon:"mdi-database-check"},{name:"Всего документов",value:r.value.report.summary.totalDocuments||0,icon:"mdi-file-document-outline"},{name:"Успешно",value:r.value.report.summary.successful||0,icon:"mdi-check-circle-outline",color:"success"},{name:"Ошибки",value:r.value.report.summary.failed||0,icon:"mdi-alert-circle-outline",color:"error"},{name:"Пропущено",value:r.value.report.summary.skipped||0,icon:"mdi-help-circle-outline",color:"gray"}]),Q=m(()=>!r.value||!r.value.report||!r.value.report.organs?[]:Object.entries(r.value.report.organs).map(([t,e])=>({code:t,name:e.name||"Unknown",total:e.total||0,success:e.success||0,failed:e.failed||0,skipped:e.skipped||0,processed:e.processed===!0}))),B=m(()=>d.value.state==="STARTED"||d.value.state==="PROGRESS"),_=m(()=>i.value&&i.value.length>0),X=m(()=>[{name:"Длительность",data:i.value.filter(e=>e.duration).slice().reverse().map(e=>e.duration)}]),Y=m(()=>{const t=i.value.filter(e=>e.duration).slice().reverse();return{chart:{type:"area",toolbar:{show:!1},zoom:!1,fontFamily:"Nunito, sans-serif"},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",color:["#"],gradient:{shadeIntensity:1,opacityFrom:.9,opacityTo:.5}},xaxis:{categories:t.map((e,l)=>`Запуск ${l+1}`),labels:{show:!1}},yaxis:{logarithmic:!1,logBase:10,labels:{show:!0,formatter:function(e){return h(e)}},title:{show:!1}},tooltip:{y:{formatter:function(e){return h(e)}}},theme:{mode:"light",palette:"palette1",monochrome:{enabled:!0,color:"#1d4c86",shadeTo:"light",shadeIntensity:.65}}}}),Z=m(()=>i.value.filter(t=>t.state==="SUCCESS").length),ee=m(()=>i.value.filter(t=>t.state==="FAILURE"||t.state==="REVOKED").length),te=m(()=>{const t=i.value.filter(p=>p.duration);if(t.length===0)return"0 сек";const l=t.reduce((p,C)=>p+C.duration,0)/t.length;return h(l)}),ae=t=>t==="SUCCESS"?"success":t==="FAILURE"||t==="REVOKED"?"error":t==="STARTED"||t==="PROGRESS"?"primary":"grey",T=async()=>{try{const t=await k.parser.status();d.value=P(t)}catch(t){console.error("Error fetching parser status:",t)}finally{w.value=!1}},x=async()=>{try{w.value=!0;const t=await k.parser.history({limit:D.value});i.value=t.history?t.history.map(P):[],i.value.length>0&&!r.value&&O()}catch(t){console.error("Error fetching parser history:",t)}finally{w.value=!1}},O=async()=>{try{const t=await k.parser.lastRun();r.value=P(t)}catch(t){if(t.response&&t.response.status===404&&i.value.length>0){const e=[...i.value].sort((l,p)=>new Date(p.startTime).getTime()-new Date(l.startTime).getTime());e[0]&&e[0].report&&(r.value={...e[0]})}else t.response&&t.response.status!==404&&console.error("Error fetching last report:",t)}},se=async()=>{try{R.value=!0,await k.parser.start(),await new Promise(t=>setTimeout(t,2e3)),await T(),await x()}catch(t){console.error("Error starting parser:",t)}finally{R.value=!1}},oe=()=>{g.value=!0},re=async()=>{g.value=!1;try{await k.parser.stop(),await T(),await x()}catch(t){console.error("Error stopping parser:",t)}},le=()=>{E=setInterval(async()=>{B.value&&await T()},3e3)};return ge(async()=>{await T(),await x(),await O(),le()}),_e(()=>{E&&clearInterval(E)}),(t,e)=>{const l=n("v-col"),p=n("v-spacer"),C=n("v-select"),$=n("v-card-title"),ne=n("apexchart"),F=n("v-card-text"),H=n("v-card"),V=n("v-chip"),I=n("v-btn"),W=n("v-data-table"),ie=n("v-checkbox-btn"),ue=n("v-row"),ce=n("v-card-actions"),de=n("v-dialog"),me=n("v-container");return c(),v(me,{fluid:""},{default:a(()=>[o(ue,{class:"justify-space-around"},{default:a(()=>[o(l,{cols:"12",md:"6"},{default:a(()=>[o(pe,{title:"Статус процесса сбора данных",status:d.value.state,message:d.value.status,progress:d.value.progress,isRunning:B.value,startLoading:R.value,startTime:d.value.startTime,endTime:d.value.endTime,duration:d.value.duration,onStart:se,onConfirm:oe},null,8,["status","message","progress","isRunning","startLoading","startTime","endTime","duration"])]),_:1}),_.value?(c(),v(l,{key:0,cols:"12",md:"6"},{default:a(()=>[o(H,{class:"h-100",elevation:"3"},{default:a(()=>[o($,{class:"d-flex align-center"},{default:a(()=>[e[4]||(e[4]=A("span",null,"Длительность",-1)),o(p),o(C,{modelValue:D.value,"onUpdate:modelValue":[e[0]||(e[0]=s=>D.value=s),x],items:[5,10,20,50],variant:"outlined",density:"compact","hide-details":"",style:{"max-width":"120px"},color:"primary"},null,8,["modelValue"])]),_:1}),o(F,null,{default:a(()=>[o(ne,{type:"area",height:"300",options:Y.value,series:X.value},null,8,["options","series"])]),_:1})]),_:1})]),_:1})):b("",!0),_.value?(c(),v(l,{key:1,cols:"12",md:"4"},{default:a(()=>[o(L,{color:"success",icon:"check",amount:Z.value,description:"Успешный сбор данных"},null,8,["amount"])]),_:1})):b("",!0),_.value?(c(),v(l,{key:2,cols:"12",md:"4"},{default:a(()=>[o(L,{color:"error",icon:"alert",amount:ee.value,description:"Ошибки при выполнении"},null,8,["amount"])]),_:1})):b("",!0),_.value?(c(),v(l,{key:3,cols:"12",md:"4"},{default:a(()=>[o(L,{color:"info",icon:"clock",amount:te.value,description:"Среднее время выполнения"},null,8,["amount"])]),_:1})):b("",!0),o(l,{cols:"12",md:_.value?6:12},{default:a(()=>[o(ve,{historyLimit:"20"},{table:a(()=>[o(W,{headers:M,items:i.value,loading:w.value,"items-per-page":"15","items-per-page-options":[15,20,50],"fixed-header":"","fixed-footer":"",height:"700",density:"compact",hover:""},{"item.state":a(({item:s})=>[o(V,{color:ae(s.state),size:"small",label:""},{default:a(()=>[u(f(s.state),1)]),_:2},1032,["color"])]),"item.duration":a(({item:s})=>[u(f(K(h)(s.duration)),1)]),"item.startTime":a(({item:s})=>[u(f(K(U)(s.startTime)),1)]),"item.summary":a(({item:s})=>[u(f(s.report.summary.organsProcessed||0),1)]),"item.taskId":a(({item:s})=>[o(I,{class:"text-none ma-1","prepend-icon":"mdi-text-box-search",variant:"text",onClick:z=>G(s.taskId)},{default:a(()=>e[5]||(e[5]=[u(" Смотреть ")])),_:2},1032,["onClick"])]),_:1},8,["items","loading"])]),_:1})]),_:1},8,["md"]),o(l,{cols:"12",md:"6"},{default:a(()=>[o(fe,{status:r.value.state,message:r.value.status,stats:J.value},{table:a(()=>[r.value&&r.value.report&&r.value.report.organs?(c(),v(W,{key:0,headers:q,items:Q.value,density:"compact","fixed-header":"","fixed-footer":"",height:"400","sort-by":N,"onUpdate:sortBy":e[1]||(e[1]=s=>N=s)},{"item.success":a(({item:s})=>[s.success>0?(c(),v(V,{key:0,color:"success",size:"small",label:""},{default:a(()=>[u(f(s.success),1)]),_:2},1024)):(c(),j("span",he,f(s.success),1))]),"item.failed":a(({item:s})=>[s.failed>0?(c(),v(V,{key:0,color:"error",size:"small",label:""},{default:a(()=>[u(f(s.failed),1)]),_:2},1024)):(c(),j("span",ke,f(s.failed),1))]),"item.processed":a(({item:s})=>[o(ie,{modelValue:s.processed,"onUpdate:modelValue":z=>s.processed=z,"hide-details":"","true-value":!0,"false-value":!1,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["items"])):b("",!0)]),_:1},8,["status","message","stats"])]),_:1})]),_:1}),o(de,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=s=>g.value=s),"max-width":"500"},{default:a(()=>[o(H,{class:"px-2 py-2"},{default:a(()=>[o($,{class:"text-h5"},{default:a(()=>e[6]||(e[6]=[u(" Подтвердите остановку ")])),_:1}),o(F,null,{default:a(()=>e[7]||(e[7]=[u(" Вы уверены, что хотите "),A("strong",null,"остановить",-1),u(" процесс сбора данных? Это действие необратимо. ")])),_:1}),o(ce,null,{default:a(()=>[o(p),o(I,{color:"primary",variant:"tonal",onClick:e[2]||(e[2]=s=>g.value=!1)},{default:a(()=>e[8]||(e[8]=[u(" Отменить ")])),_:1}),o(I,{color:"error",variant:"tonal",onClick:re},{default:a(()=>e[9]||(e[9]=[u(" Остановить ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}});export{De as default};
